#!/bin/bash

echo "installing dotfiles"

# ensure ~/.local/bin exists and is in PATH
mkdir -p ~/.local/bin
if ! grep -q 'export PATH="$HOME/.local/bin:$PATH"' ~/.bashrc; then
    echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
fi

# install JetBrains Mono Nerd Font if not present
if ! fc-list | grep -qi "JetBrainsMono Nerd"; then
    echo "installing JetBrains Mono Nerd Font"
    mkdir -p ~/.local/share/fonts
    # fix ownership if fonts dir is owned by root
    if [ "$(stat -c '%U' ~/.local/share/fonts)" = "root" ]; then
        sudo chown -R "$USER:$USER" ~/.local/share/fonts
    fi
    curl -fLo /tmp/JetBrainsMono.tar.xz -L https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.tar.xz
    mkdir -p /tmp/jetbrains-nerd-font
    tar -xf /tmp/JetBrainsMono.tar.xz -C /tmp/jetbrains-nerd-font
    mv /tmp/jetbrains-nerd-font/*.ttf ~/.local/share/fonts/
    rm -rf /tmp/JetBrainsMono.tar.xz /tmp/jetbrains-nerd-font
    fc-cache -fv
else
    echo "JetBrains Mono Nerd Font already installed"
fi

# install broot if not present
if ! command -v broot &> /dev/null; then
    echo "installing broot"
    curl -o ~/.local/bin/broot -L https://dystroy.org/broot/download/x86_64-linux/broot
    chmod +x ~/.local/bin/broot
else
    echo "broot already installed"
fi

# set up broot shell function if not present
if [ ! -f ~/.config/broot/launcher/bash/br ]; then
    echo "setting up broot shell function"
    broot --install
else
    echo "broot shell function already set up"
fi

# enable nerdfont icons in broot
if [ -f ~/.config/broot/conf.hjson ] && ! grep -q '^icon_theme:' ~/.config/broot/conf.hjson; then
    echo "enabling nerdfont icons in broot"
    sed -i 's/# icon_theme: vscode/icon_theme: nerdfont/' ~/.config/broot/conf.hjson
else
    echo "broot icons already configured"
fi

# install fzf if not present
if ! command -v fzf &> /dev/null; then
    echo "installing fzf"
    sudo apt install -y fzf
else
    echo "fzf already installed"
fi

# install xclip if not present
if ! command -v xclip &> /dev/null; then
    echo "installing xclip"
    sudo apt install -y xclip
else
    echo "xclip already installed"
fi

# install ripgrep if not present
if ! command -v rg &> /dev/null; then
    echo "installing ripgrep"
    sudo apt install -y ripgrep
else
    echo "ripgrep already installed"
fi

# install tmux if not present
if ! command -v tmux &> /dev/null; then
    echo "installing tmux"
    sudo apt install -y tmux
else
    echo "tmux already installed"
fi

# install eza if not present
if ! command -v eza &> /dev/null; then
    echo "installing eza"
    sudo apt install -y gpg
    sudo mkdir -p /etc/apt/keyrings
    wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
    echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/gierens.list
    sudo chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list
    sudo apt update
    sudo apt install -y eza
else
    echo "eza already installed"
fi

echo "linking .vim"
rm -rf ~/.vim
ln -sf ~/repo/dotfiles/.vim ~/.vim

echo "linking .vimrc"
ln -sf ~/repo/dotfiles/.vimrc ~/.vimrc

echo "linking .gitconfig"
ln -sf ~/repo/dotfiles/.gitconfig ~/.gitconfig

echo "linking .tmux.conf"
ln -sf ~/repo/dotfiles/.tmux.conf ~/.tmux.conf

echo "adding bashrc.local to .bashrc"
if ! grep -q "repo/dotfiles/.bashrc.local" ~/.bashrc; then
    echo "" >> ~/.bashrc
    echo "# load custom dotfiles config" >> ~/.bashrc
    echo "if [ -f ~/repo/dotfiles/.bashrc.local ]; then" >> ~/.bashrc
    echo "    source ~/repo/dotfiles/.bashrc.local" >> ~/.bashrc
    echo "fi" >> ~/.bashrc
fi

echo "done"
